name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-linux:
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit

  build-macos:
    uses: ./.github/workflows/build-macos.yml
    secrets: inherit

  build-windows:
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit

  create-release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -laR artifacts/ || echo "No artifacts found"

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          VERSION="${{ steps.version.outputs.version }}"
          APP="CodeStudio"

          # Linux artifacts
          if [ -d "artifacts/linux-x86_64" ]; then
            for f in artifacts/linux-x86_64/*.deb; do
              [ -f "$f" ] && cp "$f" "release-assets/${APP}_${VERSION}_linux_x86_64.deb"
            done
            for f in artifacts/linux-x86_64/*.AppImage; do
              [ -f "$f" ] && cp "$f" "release-assets/${APP}_${VERSION}_linux_x86_64.AppImage"
            done
          fi

          # macOS artifacts
          if [ -d "artifacts/macos-universal" ]; then
            for f in artifacts/macos-universal/*.dmg; do
              [ -f "$f" ] && cp "$f" "release-assets/${APP}_${VERSION}_macos_universal.dmg"
            done
            for f in artifacts/macos-universal/*.zip; do
              [ -f "$f" ] && cp "$f" "release-assets/${APP}_${VERSION}_macos_universal.app.zip"
            done
          fi

          # Windows artifacts
          if [ -d "artifacts/windows-x86_64" ]; then
            for f in artifacts/windows-x86_64/*.msi; do
              [ -f "$f" ] && cp "$f" "release-assets/${APP}_${VERSION}_windows_x86_64.msi"
            done
            for f in artifacts/windows-x86_64/*.exe; do
              [ -f "$f" ] && cp "$f" "release-assets/${APP}_${VERSION}_windows_x86_64.exe"
            done
          fi

          # Create source code archives
          CLEAN_VERSION="${VERSION#v}"
          git archive --format=tar.gz --prefix=${APP}-${CLEAN_VERSION}/ -o "release-assets/${APP}-${CLEAN_VERSION}.tar.gz" HEAD
          git archive --format=zip --prefix=${APP}-${CLEAN_VERSION}/ -o "release-assets/${APP}-${CLEAN_VERSION}.zip" HEAD

          # Generate SHA256 checksums
          cd release-assets
          for file in *; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256"
            fi
          done
          cd ..

          echo "Release assets:"
          ls -la release-assets/

      - name: Generate release body
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${{ github.repository }}"
          APP="CodeStudio"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          cat > release_body.md << EOF
          ## ${APP} ${VERSION}

          ### Downloads

          | Platform | Installer | Portable |
          |----------|-----------|----------|
          | **Windows** | [MSI Installer](${BASE_URL}/${APP}_${VERSION}_windows_x86_64.msi) | [EXE Portable](${BASE_URL}/${APP}_${VERSION}_windows_x86_64.exe) |
          | **macOS** | [DMG Installer](${BASE_URL}/${APP}_${VERSION}_macos_universal.dmg) | [App Bundle](${BASE_URL}/${APP}_${VERSION}_macos_universal.app.zip) |
          | **Linux** | [DEB Package](${BASE_URL}/${APP}_${VERSION}_linux_x86_64.deb) | [AppImage](${BASE_URL}/${APP}_${VERSION}_linux_x86_64.AppImage) |

          ### Installation

          - **Windows**: Run the \`.msi\` installer or use the portable \`.exe\` file.
          - **macOS**: Open the \`.dmg\` and drag ${APP} to Applications.
          - **Linux**: \`chmod +x\` the \`.AppImage\` and run it, or install the \`.deb\` on Debian/Ubuntu.

          ### Checksums

          SHA256 checksums (\`.sha256\`) are provided for all assets.
          EOF

          echo "Generated release body:"
          cat release_body.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: CodeStudio ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release-assets/*
          body_path: release_body.md
