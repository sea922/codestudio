name: Build macOS

on:
  workflow_call:
  workflow_dispatch:

env:
  APP_NAME: CodeStudio

jobs:
  build:
    name: Build macOS ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-13  # Intel
            target: x86_64-apple-darwin
            arch: x86_64
          - os: macos-14  # Apple Silicon
            target: aarch64-apple-darwin
            arch: aarch64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Convert icons to RGBA
        run: |
          cd src-tauri/icons
          for png in *.png; do
            if [ -f "$png" ]; then
              convert "$png" -define png:color-type=6 "temp_$png"
              mv "temp_$png" "$png"
            fi
          done

      - name: Install dependencies
        run: bun install

      - name: Import Apple certificates
        if: ${{ env.APPLE_CERTIFICATE != '' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Build Tauri app
        env:
          CI: true
        run: bun run tauri build

      - name: Upload architecture-specific artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            src-tauri/target/release/bundle/macos/${{ env.APP_NAME }}.app
            src-tauri/target/release/bundle/dmg/*.dmg
          retention-days: 1

  universal:
    name: Create Universal Binary
    needs: [build]
    if: ${{ !cancelled() && needs.build.result == 'success' }}
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: macos-*
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“ Artifact structure:"
          find artifacts -type f -name "*.app" -o -name "*.dmg" | head -20
          echo ""
          echo "ðŸ“ Full directory structure:"
          ls -laR artifacts/

      - name: Import Apple certificates
        if: ${{ env.APPLE_CERTIFICATE != '' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Create universal app
        env:
          APP_NAME: CodeStudio
        run: |
          mkdir -p dmg_temp

          # Find the actual app paths
          AARCH64_APP=$(find artifacts/macos-aarch64 -name "${APP_NAME}.app" -type d | head -1)
          X86_64_APP=$(find artifacts/macos-x86_64 -name "${APP_NAME}.app" -type d | head -1)

          if [ -z "$AARCH64_APP" ] || [ -z "$X86_64_APP" ]; then
            echo "âŒ Could not find app bundles"
            echo "AARCH64_APP: $AARCH64_APP"
            echo "X86_64_APP: $X86_64_APP"
            echo "Available files:"
            find artifacts -name "*.app" -type d
            exit 1
          fi

          echo "âœ… Found app bundles:"
          echo "  ARM64: $AARCH64_APP"
          echo "  x86_64: $X86_64_APP"

          # Copy ARM64 app as base
          cp -R "$AARCH64_APP" dmg_temp/

          # Create universal binary using lipo
          lipo -create -output "dmg_temp/${APP_NAME}.app/Contents/MacOS/${APP_NAME}" \
            "$AARCH64_APP/Contents/MacOS/${APP_NAME}" \
            "$X86_64_APP/Contents/MacOS/${APP_NAME}"

          chmod +x "dmg_temp/${APP_NAME}.app/Contents/MacOS/${APP_NAME}"

          echo "âœ… Universal binary created"
          lipo -info "dmg_temp/${APP_NAME}.app/Contents/MacOS/${APP_NAME}"

      - name: Sign app bundle
        if: ${{ env.APPLE_SIGNING_IDENTITY != '' }}
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APP_NAME: CodeStudio
        run: |
          codesign --sign "$APPLE_SIGNING_IDENTITY" \
            --timestamp \
            --options runtime \
            --force \
            --deep \
            --entitlements src-tauri/entitlements.plist \
            "dmg_temp/${APP_NAME}.app"

      - name: Create DMG
        env:
          APP_NAME: CodeStudio
        run: |
          hdiutil create -volname "${APP_NAME} Installer" \
            -srcfolder dmg_temp \
            -ov -format UDZO "${APP_NAME}.dmg"

      - name: Sign DMG
        if: ${{ env.APPLE_SIGNING_IDENTITY != '' }}
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APP_NAME: CodeStudio
        run: |
          codesign --sign "$APPLE_SIGNING_IDENTITY" \
            --timestamp \
            --force "${APP_NAME}.dmg"

      - name: Notarize DMG
        if: ${{ env.APPLE_ID != '' && env.APPLE_TEAM_ID != '' && env.APPLE_PASSWORD != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APP_NAME: CodeStudio
        run: |
          xcrun notarytool store-credentials "notarytool-profile" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_PASSWORD"

          xcrun notarytool submit "${APP_NAME}.dmg" \
            --keychain-profile "notarytool-profile" \
            --wait

      - name: Staple notarization
        if: ${{ env.APPLE_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_NAME: CodeStudio
        run: xcrun stapler staple "${APP_NAME}.dmg"

      - name: Create artifacts directory
        env:
          APP_NAME: CodeStudio
        run: |
          mkdir -p dist/macos-universal
          cp "${APP_NAME}.dmg" dist/macos-universal/

          ditto -c -k --sequesterRsrc --keepParent \
            "dmg_temp/${APP_NAME}.app" "dist/macos-universal/${APP_NAME}.app.zip"

          shasum -a 256 dist/macos-universal/* > dist/macos-universal/checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: dist/macos-universal/*

      - name: Cleanup
        if: always()
        run: |
          rm -rf dmg_temp artifacts
          if [ -n "$RUNNER_TEMP" ] && [ -f "$RUNNER_TEMP/app-signing.keychain-db" ]; then
            security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true
          fi
